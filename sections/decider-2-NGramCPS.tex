% !TeX root = ../bbchallenge-paper.tex

\newpage
\subsection{n-gram Closed Position Set (NGramCPS)}\label{sec:n-gramCPS}

\newcommand{\alphabet}{\mathcal{A}}
\newcommand{\leftngram}{left\xspace}
\newcommand{\rightngram}{right\xspace}
\newcommand{\middlesymbol}{middle\xspace}

\begin{algorithm}
    \caption{{\sc decider-NGramCPS}}\label{alg:NGramCPS}

    \begin{algorithmic}[1]
        \State{\textbf{Input:} a Turing machine `tm', the zero symbol of the alphabet $\alphabet_0$, the size of the n-grams $r > 0$.}
        \State{\textbf{Output:} `NON-HALT' if the decider detects that the machine doesn't halt and `UNKNOWN' otherwise.}

        \State $g_0 = (\alphabet_0)^r$ \Comment{The zero n-gram consists of $r$ zero symbols}
        \State $L = \{ g_0 \}$ \Comment{The seen left n-grams}
        \State $R = \{ g_0 \}$ \Comment{The seen right n-grams}
        \State $C =$ \{\{.\leftngram $=$ $g_0$, .\rightngram $=$ $g_0$, .\middlesymbol $=$ $\alphabet_0$, .state $=$ \textcolor{colorA}{A} \}\} \Comment{The seen local contexts}
        \While{true}
        \State $V = C$
        \State any\_updates $=$ false
        \While{$|V| \neq 0$}
        \State $c = V.\textbf{pop}()$
        \State $c' = c$
        \State $\{w,d,s\}$ $=$ tm(c.state, c.\middlesymbol) \Comment{Transition's write symbol, move direction, and next state}
        \State \If{$s$ is undefined} \Comment{Undefined transition is met}
        \State \textbf{return} UNKNOWN
        \EndIf
        \State \If{$d$ is Right}
        \State Add $c.\text{\leftngram}$ to $L$ \Comment{$c.\text{\leftngram}$ is the falling n-gram}
        \State Set $c'.\text{\leftngram}$ to the last $r-1$ symbols of $c.\text{\leftngram}$ followed by $w$
        \State Set $c'.\text{\middlesymbol}$ to the first symbol of $c.\text{\rightngram}$
        \For{each ngram $r\in R$ starting with the last $r-1$ symbols of $c.\text{\rightngram}$}
        \State Set $c'.\text{\rightngram}$ to $r$
        \If{$c'$ is not in $C$}
        \State \tabi Insert $c'$ in $C$
        \State \tabi Insert $c'$ in $V$
        \State \tabi any\_updates $=$ true
        \EndIf
        \EndFor
        \EndIf
        \State \If{$d$ is Left}
        \State Add $c.\text{\rightngram}$ to $R$ \Comment{$c.\text{\rightngram}$ is the falling n-gram}
        \State Set $c'.\text{\rightngram}$ to the first $r-1$ symbols of $c.\text{\rightngram}$ preceded by $w$
        \State Set $c'.\text{\middlesymbol}$ to the last symbol of $c.\text{\leftngram}$
        \For{each ngram $l \in L$ ending with the first $r-1$ symbols of $c.\text{\leftngram}$}
        \State Set $c'.\text{\leftngram}$ to $l$
        \If{$c'$ is not in $C$}
        \State \tabi Insert $c'$ in $C$
        \State \tabi Insert $c'$ in $V$
        \State \tabi any\_updates $=$ true
        \EndIf
        \EndFor
        \EndIf
        \EndWhile
        \State \If{\textbf{not} any\_updates}
        \State \textbf{return} NON-HALT
        \EndIf

        \EndWhile
    \end{algorithmic}
\end{algorithm}